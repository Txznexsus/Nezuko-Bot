// Comando: .rch
// Ejemplo: .rch 12 ðŸ‘» 14 ðŸ™‚ 288 ðŸ¥µ 400 ðŸŒ¿ hola buenas tardes xd | https://whatsapp.com/channel/0029VchAGrYXXXX

const sleep = (ms) => new Promise(res => setTimeout(res, ms));

let handler = async (m, { conn, text }) => {
  if (!text) return conn.reply(m.chat, `âš ï¸ Ejemplo correcto:\n\n.rch 12 ðŸ‘» 14 ðŸ™‚ 288 ðŸ¥µ 400 ðŸŒ¿ hola buenas tardes xd | https://whatsapp.com/channel/0029VchAGrYXXXX`, m);

  // Separar mensaje de canal y link
  const [mensaje, canalRaw] = text.split('|').map(s => s.trim());
  if (!mensaje || !canalRaw) return conn.reply(m.chat, `âŒ Formato incorrecto.\nUsa: .rch 10 ðŸ˜‚ 20 ðŸ˜ˆ tu mensaje aquÃ­ | link o ID del canal`, m);

  // Detectar link o ID del canal
  let channelID = canalRaw
    .replace("https://whatsapp.com/channel/", "")
    .replace("@newsletter", "")
    .trim();

  const newsletterJid = `${channelID}@newsletter`;

  // Separar pares cantidad + emoji del texto del mensaje
  const regex = /(\d+)\s*([\p{Emoji_Presentation}\p{Emoji}\uFE0F\u200D]+)/gu;
  const reactions = [...mensaje.matchAll(regex)].map(m => ({
    count: parseInt(m[1]),
    emoji: m[2]
  }));

  // El mensaje real (sin los pares)
  const msgReal = mensaje.replace(regex, '').trim();

  if (!reactions.length) return conn.reply(m.chat, `âš ï¸ No detectÃ© reacciones vÃ¡lidas.\nEjemplo: .rch 15 ðŸ˜‚ 20 ðŸ˜ˆ mensaje | link`, m);
  if (!msgReal) return conn.reply(m.chat, `âš ï¸ Debes escribir un mensaje o adjuntar algo para publicar.`, m);

  await conn.reply(m.chat, `ðŸ“¨ Publicando en canal y enviando reacciones...\n\nðŸ“ Mensaje: *${msgReal}*\nðŸŽ­ Reacciones:\n${reactions.map(r => `â€¢ ${r.count}x ${r.emoji}`).join('\n')}`, m);

  try {
    // Enviar mensaje al canal
    const sent = await conn.sendMessage(newsletterJid, { text: msgReal });
    const serverMessageId = sent?.key?.id || 100;

    await sleep(800); // esperar antes de reaccionar

    for (const r of reactions) {
      for (let i = 0; i < r.count; i++) {
        await conn.sendMessage(newsletterJid, {
          reaction: {
            text: r.emoji,
            key: {
              remoteJid: newsletterJid,
              fromMe: false,
              id: serverMessageId,
              participant: "0@s.whatsapp.net"
            }
          }
        });
        await sleep(100);
      }
    }

    await conn.reply(m.chat, `âœ… Listo, publicado en el canal y enviadas las reacciones.`, m);
  } catch (e) {
    console.error(e);
    await conn.reply(m.chat, `âŒ Error al publicar o reaccionar.\nVerifica que el bot tenga acceso al canal.`, m);
  }
};

handler.help = ["rch <cantidades + emojis> <mensaje> | <link canal>"];
handler.tags = ["owner"];
handler.command = /^rch$/i;
handler.rowner = true;

export default handler;